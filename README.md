# Is it Observable
<p align="center"><img src="/image/logo.png" width="40%" alt="Is It observable Logo" /></p>

## Episode : Nginx Instrumentation
This repository contains the files utilized during the tutorial presented in the dedicated IsItObservable episode related to Nginx Instrumentation.
<p align="center"><img src="/image/NGINX-Ingress-Controller.png" width="40%" alt="nginx Logo" /></p>

this tutorial will also utilize the OpenTelemetry Operator with:
* the OpenTelemetry Demo
* the hipster-shop
* nginx

* All the observability data generated by the environment would be sent to Dynatrace.

## Prerequisite
The following tools need to be install on your machine :
- jq
- kubectl
- git
- gcloud ( if you are using GKE)
- Helm


### 1.Create a Google Cloud Platform Project
```shell
PROJECT_ID="<your-project-id>"
gcloud services enable container.googleapis.com --project ${PROJECT_ID}
gcloud services enable monitoring.googleapis.com \
cloudtrace.googleapis.com \
clouddebugger.googleapis.com \
cloudprofiler.googleapis.com \
--project ${PROJECT_ID}
```
### 2.Create a GKE cluster
```shell
ZONE=europe-west3-a
NAME=isitobservable-nginx-instrumentation
gcloud container clusters create ${NAME} --zone=${ZONE} --machine-type=e2-standard-4 --num-nodes=2
```


### 3. Clone Github repo

```shell
git clone  https://github.com/isitobservable/nginx-instrumentation
cd nginx-instrumentation
```



## Getting started


### Dynatrace Tenant
#### 1. Dynatrace Tenant - start a trial
If you don't have any Dynatrace tenant , then I suggest to create a trial using the following link : [Dynatrace Trial](https://dt-url.net/observable-trial)
Once you have your Tenant save the Dynatrace tenant url in the variable `DT_TENANT_URL` (for example : https://dedededfrf.live.dynatrace.com)
```
DT_TENANT_URL=<YOUR TENANT Host>
```

##### 2. Create the Dynatrace API Tokens
The dynatrace operator will require to have several tokens:
* Token to deploy and configure the various components
* Token to ingest metrics and Traces


###### Operator Token
One for the operator having the following scope:
* Create ActiveGate tokens
* Read entities
* Read Settings
* Write Settings
* Access problem and event feed, metrics and topology
* Read configuration
* Write configuration
* Paas integration - installer downloader
<p align="center"><img src="/image/operator_token.png" width="40%" alt="operator token" /></p>

Save the value of the token . We will use it later to store in a k8S secret
```shell
API_TOKEN=<YOUR TOKEN VALUE>
```
###### Ingest data token
Create a Dynatrace token with the following scope:
* Ingest metrics (metrics.ingest)
* Ingest logs (logs.ingest)
* Ingest events (events.ingest)
* Ingest OpenTelemetry
* Read metrics
<p align="center"><img src="/image/data_ingest_token.png" width="40%" alt="data token" /></p>
Save the value of the token . We will use it later to store in a k8S secret

```shell
DATA_INGEST_TOKEN=<YOUR TOKEN VALUE>
```


### Deploy most of the components 
The application will deploy the entire environment:
```shell
chmod 777 deployment.sh
./deployment.sh  --clustername "${NAME}" --dturl "${DT_TENANT_URL}" --dtingesttoken "${DATA_INGEST_TOKEN}" --dtoperatortoken "${API_TOKEN}" 
```

## Tutorial Steps

### Nginx Ingress controller
The deployment script of this tutorial has already:
- enabled the tracing on the ingress
- added the right annotations to the ingress rules 

If you open your Dynatrace Tenant, and open The `Services` application , you should find a dedicated service for our ingress controller

<p align="center"><img src="/image/services.png" width="70%" alt="services /></p>

and if you open this service you will find all the various application using this ingress:

<p align="center"><img src="/image/nginx_ingress.png" width="70%" alt="nginx /></p>

you can select one of the distributes traces, in my case i clicked on the Checkout transaction

<p align="center"><img src="/image/distributed_trace.png" width="70%" alt="traces /></p>

### Nginx Web Server instrumentation

Now let's instrument a traditionnal nginx webserver.
To do so we will first need to create a specific namespace:
```shell
kubectl create ns nginx-example
kubectl label namespace  nginx-example oneagent=false
```

Then we want to configure the instrumentation that would be applied on our future nginx deployment:
```shell
kubect apply -f opentelemetry/Instrumentation.yaml -n nginx-example
```

Once the instrumentation object is deployed you can deploy your nginx deployments:
```shell
kubect apply -f  nginx/basic_web1.yaml -n nginx-example
kubect apply -f nginx/nginx_deploy.yaml -n nginx-example
IP=$(kubectl get svc ingress-nginx-controller -n ingress-nginx -ojson | jq -j '.status.loadBalancer.ingress[].ip')
```

if now you open you browser on the url : `http://nginx1.$IP.nip.io` and wait few seconds

you can open your Dynatrace Tenant, and open The `Services` application , you should find a dedicated service for our nginx1 webserver

<p align="center"><img src="/image/nginx1.png" width="70%" alt="nginx1 /></p>

and if you open this service you will find all the various application using this ingress:

<p align="center"><img src="/image/nginx1_service.png" width="70%" alt="webserver_service /></p>

you can select one of the distributes traces availabe in this screen you will see the trace produced by the auto-instrumentation :

<p align="center"><img src="/image/nginx1_trace.png" width="70%" alt="traces /></p>
